# è‚¡ç¥¨æ•°æ®APIåç«¯

ä¸€ä¸ªåŸºäºFlaskçš„è‚¡ç¥¨æ•°æ®APIæœåŠ¡ï¼Œæä¾›è‚¡ç¥¨æœç´¢ã€è¯¦æƒ…æŸ¥è¯¢ã€å†å²æ•°æ®è·å–å’Œå…³æ³¨åˆ—è¡¨ç®¡ç†åŠŸèƒ½ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- pip åŒ…ç®¡ç†å™¨

### å®‰è£…æ­¥éª¤

1. **è¿›å…¥åç«¯ç›®å½•**
   ```bash
   cd backend
   ```

2. **å®‰è£…ä¾èµ–åŒ…**
   ```bash
   pip install -r requirements.txt
   ```

3. **å¯åŠ¨æœåŠ¡**
   ```bash
   python run.py
   ```
   æˆ–è€…
   ```bash
   python app.py
   ```

4. **éªŒè¯æœåŠ¡**
   æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:5000/api/health

## ğŸ“š APIæ¥å£æ–‡æ¡£

### åŸºç¡€ä¿¡æ¯

- **æœåŠ¡åœ°å€**: http://localhost:5000
- **APIå‰ç¼€**: /api
- **è¿”å›æ ¼å¼**: JSON
- **å­—ç¬¦ç¼–ç **: UTF-8

### é€šç”¨å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "success": true,
  "data": {},
  "message": "æ“ä½œæˆåŠŸ"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "success": false,
  "error": "é”™è¯¯æè¿°",
  "error_code": "ERROR_CODE"
}
```

### æ¥å£åˆ—è¡¨

#### 1. å¥åº·æ£€æŸ¥

**æ¥å£**: `GET /api/health`

**æè¿°**: æ£€æŸ¥APIæœåŠ¡çŠ¶æ€

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "version": "1.0.0",
    "timestamp": 1703123456.789
  },
  "message": "è‚¡ç¥¨æ•°æ®APIæœåŠ¡æ­£å¸¸è¿è¡Œ"
}
```

#### 2. è‚¡ç¥¨æœç´¢

**æ¥å£**: `GET /api/stocks/search`

**å‚æ•°**:
- `keyword` (å¿…éœ€): æœç´¢å…³é”®è¯ï¼Œå¯ä»¥æ˜¯è‚¡ç¥¨ä»£ç æˆ–åç§°
- `limit` (å¯é€‰): è¿”å›ç»“æœæ•°é‡é™åˆ¶ï¼Œé»˜è®¤20

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/stocks/search?keyword=ä¸­è¿œæµ·æ§
GET /api/stocks/search?keyword=601919
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "code": "601919",
      "name": "ä¸­è¿œæµ·æ§",
      "price": 14.94,
      "change_percent": 4.69,
      "change_amount": 0.67,
      "volume": 12345678,
      "turnover": 184567890.12
    }
  ],
  "count": 1,
  "keyword": "ä¸­è¿œæµ·æ§"
}
```

#### 3. è‚¡ç¥¨è¯¦æƒ…

**æ¥å£**: `GET /api/stocks/{stock_code}`

**å‚æ•°**:
- `stock_code`: 6ä½è‚¡ç¥¨ä»£ç 

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/stocks/601919
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "code": "601919",
    "name": "ä¸­è¿œæµ·æ§",
    "price": 14.94,
    "change_percent": 4.69,
    "change_amount": 0.67,
    "volume": 12345678,
    "turnover": 184567890.12,
    "high": 15.20,
    "low": 14.50,
    "open": 14.80,
    "yesterday_close": 14.27,
    "market_cap": "2355äº¿",
    "pe_ratio": 4.69,
    "pb_ratio": 0.26,
    "roe": 17.82,
    "eps": 3.18,
    "bps": 57.42,
    "dividend_yield": 0.35,
    "is_watched": false,
    "timestamp": "2024-01-01T12:00:00"
  }
}
```

#### 4. è‚¡ç¥¨å†å²æ•°æ®

**æ¥å£**: `GET /api/stocks/{stock_code}/history`

**å‚æ•°**:
- `stock_code`: 6ä½è‚¡ç¥¨ä»£ç 
- `period` (å¯é€‰): æ—¶é—´å‘¨æœŸï¼Œæ”¯æŒ 1d, 1w, 1m, 3m, 6m, 1yï¼Œé»˜è®¤1y

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/stocks/601919/history?period=1m
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "date": "2024-01-01",
      "open": 14.50,
      "close": 14.80,
      "high": 15.00,
      "low": 14.30,
      "volume": 12345678,
      "turnover": 184567890.12,
      "change_percent": 2.07,
      "change_amount": 0.30
    }
  ],
  "count": 30,
  "period": "1m",
  "stock_code": "601919"
}
```

#### 5. æ‰¹é‡è·å–è‚¡ç¥¨æ•°æ®

**æ¥å£**: `POST /api/stocks/batch`

**è¯·æ±‚ä½“**:
```json
{
  "codes": ["601919", "600919", "000001"]
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "stocks": [
      {
        "code": "601919",
        "name": "ä¸­è¿œæµ·æ§",
        "price": 14.94
      }
    ],
    "requested_count": 3,
    "valid_count": 3,
    "success_count": 1,
    "invalid_codes": []
  }
}
```

#### 6. è·å–å…³æ³¨åˆ—è¡¨

**æ¥å£**: `GET /api/watchlist`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "code": "601919",
      "name": "ä¸­è¿œæµ·æ§",
      "industry": "èˆªè¿æ¸¯å£",
      "added_time": "2024-01-01 12:00:00",
      "updated_time": "2024-01-01 12:00:00",
      "current_price": 14.94,
      "change_percent": 4.69,
      "change_amount": 0.67
    }
  ],
  "count": 1
}
```

#### 7. æ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨

**æ¥å£**: `POST /api/watchlist`

**è¯·æ±‚ä½“**:
```json
{
  "code": "601919",
  "industry": "èˆªè¿æ¸¯å£"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "code": "601919",
    "name": "ä¸­è¿œæµ·æ§",
    "industry": "èˆªè¿æ¸¯å£"
  },
  "message": "æ·»åŠ åˆ°å…³æ³¨åˆ—è¡¨æˆåŠŸ"
}
```

#### 8. åˆ é™¤å…³æ³¨çš„è‚¡ç¥¨

**æ¥å£**: `DELETE /api/watchlist/{stock_code}`

**è¯·æ±‚ç¤ºä¾‹**:
```
DELETE /api/watchlist/601919
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "code": "601919"
  },
  "message": "ä»å…³æ³¨åˆ—è¡¨åˆ é™¤æˆåŠŸ"
}
```

#### 9. å¸‚åœºæ¦‚è§ˆ

**æ¥å£**: `GET /api/market/overview`

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "indices": {
      "ä¸Šè¯æŒ‡æ•°": {
        "code": "000001",
        "name": "ä¸Šè¯æŒ‡æ•°",
        "price": 3200.50,
        "change_percent": 1.25,
        "change_amount": 39.50
      }
    },
    "timestamp": "2024-01-01T12:00:00"
  }
}
```

#### 10. ç®¡ç†æ¥å£

**æ¸…ç©ºç¼“å­˜**: `POST /api/cache/clear`

**APIç»Ÿè®¡**: `GET /api/stats?hours=24`

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒé…ç½®

é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡ `FLASK_ENV` æ¥åˆ‡æ¢é…ç½®ï¼š

- `development`: å¼€å‘ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰
- `production`: ç”Ÿäº§ç¯å¢ƒ
- `testing`: æµ‹è¯•ç¯å¢ƒ

### ä¸»è¦é…ç½®é¡¹

- **ç¼“å­˜æ—¶é—´**: 5åˆ†é’Ÿ
- **è¯·æ±‚é¢‘ç‡é™åˆ¶**: æ¯åˆ†é’Ÿ60æ¬¡
- **æ‰¹é‡æŸ¥è¯¢é™åˆ¶**: æœ€å¤š20åªè‚¡ç¥¨
- **æœç´¢ç»“æœé™åˆ¶**: æœ€å¤š20æ¡

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app.py              # ä¸»åº”ç”¨æ–‡ä»¶
â”œâ”€â”€ run.py              # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ config.py           # é…ç½®æ–‡ä»¶
â”œâ”€â”€ database.py         # æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ stock_service.py    # è‚¡ç¥¨æ•°æ®æœåŠ¡
â”œâ”€â”€ api_routes.py       # APIè·¯ç”±
â”œâ”€â”€ requirements.txt    # ä¾èµ–åŒ…åˆ—è¡¨
â”œâ”€â”€ README.md          # è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ stock_data.db      # SQLiteæ•°æ®åº“ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â””â”€â”€ stock_api.log      # æ—¥å¿—æ–‡ä»¶ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
```

## ğŸ› ï¸ å¼€å‘è¯´æ˜

### æ•°æ®æº

æœ¬é¡¹ç›®ä½¿ç”¨ [AKShare](https://akshare.akfamily.xyz/) åº“è·å–è‚¡ç¥¨æ•°æ®ï¼Œè¿™æ˜¯ä¸€ä¸ªå…è´¹çš„é‡‘èæ•°æ®æ¥å£åº“ã€‚

### ç¼“å­˜æœºåˆ¶

- è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯ç¼“å­˜5åˆ†é’Ÿ
- æœç´¢ç»“æœç¼“å­˜5åˆ†é’Ÿ
- å†å²æ•°æ®ç¼“å­˜5åˆ†é’Ÿ

### é”™è¯¯å¤„ç†

æ‰€æœ‰APIéƒ½æœ‰ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š

- å‚æ•°éªŒè¯
- æ•°æ®æ ¼å¼æ£€æŸ¥
- å¤–éƒ¨APIè°ƒç”¨å¼‚å¸¸
- æ•°æ®åº“æ“ä½œå¼‚å¸¸
- è¯·æ±‚é¢‘ç‡é™åˆ¶

### æ—¥å¿—è®°å½•

- æ‰€æœ‰APIè°ƒç”¨éƒ½ä¼šè®°å½•æ—¥å¿—
- é”™è¯¯ä¿¡æ¯ä¼šè¯¦ç»†è®°å½•
- æ—¥å¿—æ–‡ä»¶ï¼š`stock_api.log`

## ğŸš¨ å¸¸è§é—®é¢˜

### 1. å®‰è£…ä¾èµ–å¤±è´¥

**é—®é¢˜**: pip install å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å‡çº§pip
pip install --upgrade pip

# ä½¿ç”¨å›½å†…é•œåƒæº
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple/
```

### 2. AKShareæ•°æ®è·å–å¤±è´¥

**é—®é¢˜**: è‚¡ç¥¨æ•°æ®è·å–è¿”å›ç©ºæˆ–é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- ç¡®è®¤è‚¡ç¥¨ä»£ç æ ¼å¼æ­£ç¡®ï¼ˆ6ä½æ•°å­—ï¼‰
- é‡è¯•è¯·æ±‚ï¼ˆæœ‰ç¼“å­˜æœºåˆ¶ï¼‰

### 3. æ•°æ®åº“æƒé™é—®é¢˜

**é—®é¢˜**: SQLiteæ•°æ®åº“åˆ›å»ºå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿å½“å‰ç›®å½•æœ‰å†™æƒé™
- æ£€æŸ¥ç£ç›˜ç©ºé—´

### 4. ç«¯å£å ç”¨

**é—®é¢˜**: 5000ç«¯å£è¢«å ç”¨

**è§£å†³æ–¹æ¡ˆ**:
```bash
# Windows
netstat -ano | findstr :5000
taskkill /PID <PID> /F

# æˆ–ä¿®æ”¹app.pyä¸­çš„ç«¯å£å·
app.run(host='0.0.0.0', port=5001, debug=config.DEBUG)
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

1. **ç¼“å­˜ç­–ç•¥**: åˆç†è®¾ç½®ç¼“å­˜æ—¶é—´ï¼Œå‡å°‘APIè°ƒç”¨
2. **æ‰¹é‡æŸ¥è¯¢**: ä½¿ç”¨æ‰¹é‡æ¥å£å‡å°‘è¯·æ±‚æ¬¡æ•°
3. **è¯·æ±‚é¢‘ç‡**: éµå®ˆé¢‘ç‡é™åˆ¶ï¼Œé¿å…è¢«é™æµ
4. **æ•°æ®åº“ç´¢å¼•**: å…³æ³¨åˆ—è¡¨æŸ¥è¯¢å·²ä¼˜åŒ–ç´¢å¼•

## ğŸ”’ å®‰å…¨è¯´æ˜

1. **CORSé…ç½®**: å·²é…ç½®è·¨åŸŸè®¿é—®
2. **è¯·æ±‚é¢‘ç‡é™åˆ¶**: é˜²æ­¢APIæ»¥ç”¨
3. **è¾“å…¥éªŒè¯**: æ‰€æœ‰è¾“å…¥éƒ½ç»è¿‡éªŒè¯
4. **é”™è¯¯å¤„ç†**: ä¸æš´éœ²æ•æ„Ÿä¿¡æ¯

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. Pythonç‰ˆæœ¬æ˜¯å¦ç¬¦åˆè¦æ±‚
2. ä¾èµ–åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…
3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
4. æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯

---

**ç‰ˆæœ¬**: 1.0.0  
**æ›´æ–°æ—¶é—´**: 2024å¹´1æœˆ  
**ä½œè€…**: AIåŠ©æ‰‹