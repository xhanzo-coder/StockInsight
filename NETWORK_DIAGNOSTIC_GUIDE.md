# StockInsight 网络诊断工具

## 功能概述

为了解决用户在使用 StockInsight 时遇到的"网络连接失败"问题，我们开发了一套完整的网络诊断工具。该工具能够自动检测和诊断前端到后端的网络连接问题，并提供详细的解决建议。

## 主要功能

### 1. 自动网络诊断
- **后端基础连接测试**: 检查后端服务器是否可达
- **健康检查接口测试**: 验证API健康检查端点
- **CORS配置测试**: 检查跨域资源共享配置
- **认证接口测试**: 验证登录API是否正常
- **关注列表接口测试**: 检查核心业务API

### 2. 智能错误提示
- 当检测到网络连接失败时，自动弹出诊断建议
- 根据错误类型提供具体的解决方案
- 支持一键启动网络诊断工具

### 3. 详细诊断报告
- 显示每项测试的结果和耗时
- 提供错误详情和调试信息
- 支持下载 Markdown 格式的诊断报告
- 包含网络环境信息和解决建议

## 使用方法

### 在主应用中使用
1. 登录到 StockInsight 应用
2. 在仪表板页面点击"网络诊断"按钮
3. 查看诊断结果并根据建议解决问题
4. 可下载详细报告用于技术支持

### 独立测试页面
访问 `http://localhost:3000/network-diagnostic-test.html` 可以使用独立的诊断工具进行测试。

## 技术实现

### 核心组件
- `NetworkDiagnostic` 类: 核心诊断逻辑
- `DashboardPage` 组件: 集成诊断功能的主界面
- 诊断抽屉: 显示诊断结果的UI组件

### 诊断项目
1. **后端基础连接** (`testBackendConnection`)
   - 使用 `no-cors` 模式测试基础连接
   - 检测服务器是否启动

2. **健康检查接口** (`testHealthCheck`)
   - 测试 `/api/health` 端点
   - 验证API服务状态

3. **CORS配置** (`testCORS`)
   - 发送 OPTIONS 预检请求
   - 检查跨域头配置

4. **认证接口** (`testAuthAPI`)
   - 测试 `/api/auth/login` 端点
   - 验证认证服务可用性

5. **关注列表接口** (`testWatchlistNoToken`)
   - 测试 `/api/watchlist` 端点
   - 验证业务API可达性

### 错误处理增强
- 改进了 API 服务的重试机制
- 添加了指数退避策略
- 增强了错误信息的详细程度
- 支持超时检测和网络错误分类

## 常见问题解决

### 1. 后端服务未启动
**症状**: 后端基础连接测试失败
**解决方案**:
- 确认后端服务已启动 (`python app.py`)
- 检查端口5000是否被占用
- 确认防火墙设置允许访问端口5000

### 2. CORS配置问题
**症状**: CORS测试失败
**解决方案**:
- 检查后端CORS配置是否包含前端域名
- 确认浏览器没有阻止跨域请求
- 验证 `config.py` 中的 `CORS_ORIGINS` 设置

### 3. 网络超时
**症状**: 请求超时错误
**解决方案**:
- 检查网络连接稳定性
- 尝试增加超时时间
- 重启网络服务

### 4. 认证问题
**症状**: 401未授权错误
**解决方案**:
- 检查token是否有效
- 重新登录获取新token
- 确认认证服务正常

## 文件结构

```
frontend/src/
├── utils/
│   └── networkDiagnostic.ts     # 网络诊断核心逻辑
├── pages/
│   └── DashboardPage.tsx        # 集成诊断功能的主页面
└── services/
    └── api.ts                   # 增强的API服务

frontend/public/
└── network-diagnostic-test.html # 独立测试页面
```

## 配置说明

### 超时设置
- 基础连接测试: 5秒
- API接口测试: 10秒
- 重试间隔: 1秒（指数退避）
- 最大重试次数: 3次

### 支持的错误类型
- `ECONNREFUSED`: 连接被拒绝
- `NETWORK_ERROR`: 网络错误
- `TIMEOUT`: 请求超时
- HTTP状态码错误: 401, 403, 500等

## 未来改进

1. **更多诊断项目**
   - DNS解析测试
   - 网络延迟测试
   - 带宽测试

2. **自动修复功能**
   - 自动重试失败的请求
   - 智能切换API端点
   - 缓存降级策略

3. **监控集成**
   - 实时网络状态监控
   - 错误统计和分析
   - 性能指标收集

## 总结

网络诊断工具为 StockInsight 提供了强大的网络问题排查能力，能够帮助用户快速识别和解决网络连接问题，提升了应用的可用性和用户体验。通过详细的诊断报告和智能的错误提示，用户可以更好地理解和解决遇到的网络问题。