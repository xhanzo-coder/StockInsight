<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœç´¢åŠŸèƒ½æµ‹è¯• - StockInsight</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1d29;
            color: #ffffff;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .test-section {
            background: #2a2d3a;
            border: 1px solid #3a3d4a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-title {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .test-item {
            margin-bottom: 15px;
            padding: 10px;
            background: #222530;
            border-radius: 8px;
        }
        
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .test-button:hover {
            background: #5a6fd8;
        }
        
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #1a1d29;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }
        
        .success {
            border-left-color: #22c55e;
            color: #22c55e;
        }
        
        .error {
            border-left-color: #ef4444;
            color: #ef4444;
        }
        
        .warning {
            border-left-color: #f59e0b;
            color: #f59e0b;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-success { background: #22c55e; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .status-info { background: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æœç´¢åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
            <p>æµ‹è¯•æœç´¢æ¡†çš„æ ·å¼å’ŒåŠŸèƒ½ä¿®å¤æ•ˆæœ</p>
        </div>

        <div class="test-section">
            <div class="test-title">1. æœç´¢APIè¿æ¥æµ‹è¯•</div>
            <div class="test-item">
                <button class="test-button" onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
                <div id="api-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">2. æœç´¢åŠŸèƒ½æµ‹è¯•</div>
            <div class="test-item">
                <button class="test-button" onclick="testSearch('å¹³å®‰')">æœç´¢"å¹³å®‰"</button>
                <button class="test-button" onclick="testSearch('000001')">æœç´¢"000001"</button>
                <button class="test-button" onclick="testSearch('æ‹›å•†é“¶è¡Œ')">æœç´¢"æ‹›å•†é“¶è¡Œ"</button>
                <button class="test-button" onclick="testSearch('æ±Ÿè‹é“¶è¡Œ')">æœç´¢"æ±Ÿè‹é“¶è¡Œ"</button>
                <div id="search-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">3. è¾¹ç•Œæƒ…å†µæµ‹è¯•</div>
            <div class="test-item">
                <button class="test-button" onclick="testSearch('')">ç©ºå­—ç¬¦ä¸²æœç´¢</button>
                <button class="test-button" onclick="testSearch('a')">å•å­—ç¬¦æœç´¢</button>
                <button class="test-button" onclick="testSearch('ä¸å­˜åœ¨çš„è‚¡ç¥¨')">æ— æ•ˆè‚¡ç¥¨æœç´¢</button>
                <button class="test-button" onclick="testSearch('123456789')">æ— æ•ˆä»£ç æœç´¢</button>
                <div id="edge-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">4. æ€§èƒ½æµ‹è¯•</div>
            <div class="test-item">
                <button class="test-button" onclick="testPerformance()">æ‰¹é‡æœç´¢æ€§èƒ½æµ‹è¯•</button>
                <div id="performance-result" class="result" style="display: none;"></div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">5. å®æ—¶çŠ¶æ€ç›‘æ§</div>
            <div class="test-item">
                <div id="status-monitor">
                    <p><span class="status-indicator status-info"></span>å‰ç«¯æœåŠ¡: <span id="frontend-status">æ£€æµ‹ä¸­...</span></p>
                    <p><span class="status-indicator status-info"></span>åç«¯æœåŠ¡: <span id="backend-status">æ£€æµ‹ä¸­...</span></p>
                    <p><span class="status-indicator status-info"></span>æœç´¢API: <span id="search-api-status">æ£€æµ‹ä¸­...</span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIåŸºç¡€URL
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/health`);
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… APIè¿æ¥æˆåŠŸ</strong><br>
                        çŠ¶æ€: ${data.status}<br>
                        æ¶ˆæ¯: ${data.message}<br>
                        æ—¶é—´æˆ³: ${new Date(data.data.timestamp * 1000).toLocaleString()}
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ APIè¿æ¥å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ APIè¿æ¥å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•æœç´¢åŠŸèƒ½
        async function testSearch(keyword) {
            const resultDiv = document.getElementById('search-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `æ­£åœ¨æœç´¢"${keyword}"...`;
            
            try {
                const startTime = Date.now();
                const response = await fetch(`${API_BASE_URL}/stocks/search?keyword=${encodeURIComponent(keyword)}&limit=5`);
                const endTime = Date.now();
                const data = await response.json();
                
                if (response.ok && data.success) {
                    resultDiv.className = 'result success';
                    let html = `
                        <strong>âœ… æœç´¢æˆåŠŸ</strong><br>
                        å…³é”®è¯: "${keyword}"<br>
                        å“åº”æ—¶é—´: ${endTime - startTime}ms<br>
                        ç»“æœæ•°é‡: ${data.data.length}<br>
                    `;
                    
                    if (data.data.length > 0) {
                        html += '<br><strong>æœç´¢ç»“æœ:</strong><br>';
                        data.data.forEach((stock, index) => {
                            html += `${index + 1}. ${stock.name} (${stock.code}) - Â¥${stock.current_price}<br>`;
                        });
                    }
                    
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.className = 'result warning';
                    resultDiv.innerHTML = `âš ï¸ æœç´¢æ— ç»“æœ: ${data.message || 'æœªæ‰¾åˆ°ç›¸å…³è‚¡ç¥¨'}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æœç´¢å¤±è´¥: ${error.message}`;
            }
        }
        
        // è¾¹ç•Œæƒ…å†µæµ‹è¯•
        async function testEdgeCase(keyword) {
            const resultDiv = document.getElementById('edge-result');
            resultDiv.style.display = 'block';
            
            if (keyword === '') {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'âš ï¸ ç©ºå­—ç¬¦ä¸²æµ‹è¯•: å‰ç«¯åº”è¯¥é˜»æ­¢ç©ºæœç´¢';
                return;
            }
            
            if (keyword.length === 1) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'âš ï¸ å•å­—ç¬¦æµ‹è¯•: å‰ç«¯åº”è¯¥è¦æ±‚è‡³å°‘2ä¸ªå­—ç¬¦';
                return;
            }
            
            await testSearch(keyword);
        }
        
        // æ€§èƒ½æµ‹è¯•
        async function testPerformance() {
            const resultDiv = document.getElementById('performance-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'æ­£åœ¨è¿›è¡Œæ€§èƒ½æµ‹è¯•...';
            
            const keywords = ['å¹³å®‰', 'æ‹›å•†', 'æ±Ÿè‹', '000001', '600036', '600919'];
            const results = [];
            
            try {
                for (const keyword of keywords) {
                    const startTime = Date.now();
                    const response = await fetch(`${API_BASE_URL}/stocks/search?keyword=${encodeURIComponent(keyword)}&limit=3`);
                    const endTime = Date.now();
                    const data = await response.json();
                    
                    results.push({
                        keyword,
                        responseTime: endTime - startTime,
                        success: response.ok && data.success,
                        resultCount: data.success ? data.data.length : 0
                    });
                }
                
                const avgResponseTime = results.reduce((sum, r) => sum + r.responseTime, 0) / results.length;
                const successRate = results.filter(r => r.success).length / results.length * 100;
                
                resultDiv.className = 'result success';
                let html = `
                    <strong>ğŸ“Š æ€§èƒ½æµ‹è¯•ç»“æœ</strong><br>
                    å¹³å‡å“åº”æ—¶é—´: ${avgResponseTime.toFixed(2)}ms<br>
                    æˆåŠŸç‡: ${successRate.toFixed(1)}%<br>
                    <br><strong>è¯¦ç»†ç»“æœ:</strong><br>
                `;
                
                results.forEach(result => {
                    const status = result.success ? 'âœ…' : 'âŒ';
                    html += `${status} "${result.keyword}": ${result.responseTime}ms (${result.resultCount}æ¡ç»“æœ)<br>`;
                });
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        // çŠ¶æ€ç›‘æ§
        async function checkServiceStatus() {
            // æ£€æŸ¥å‰ç«¯æœåŠ¡
            try {
                const frontendResponse = await fetch('/');
                document.getElementById('frontend-status').textContent = frontendResponse.ok ? 'âœ… è¿è¡Œæ­£å¸¸' : 'âŒ å“åº”å¼‚å¸¸';
                document.querySelector('#status-monitor p:nth-child(1) .status-indicator').className = 
                    'status-indicator ' + (frontendResponse.ok ? 'status-success' : 'status-error');
            } catch (error) {
                document.getElementById('frontend-status').textContent = 'âŒ è¿æ¥å¤±è´¥';
                document.querySelector('#status-monitor p:nth-child(1) .status-indicator').className = 'status-indicator status-error';
            }
            
            // æ£€æŸ¥åç«¯æœåŠ¡
            try {
                const backendResponse = await fetch(`${API_BASE_URL}/health`);
                const backendData = await backendResponse.json();
                document.getElementById('backend-status').textContent = 
                    backendResponse.ok ? `âœ… è¿è¡Œæ­£å¸¸ (${backendData.status})` : 'âŒ å“åº”å¼‚å¸¸';
                document.querySelector('#status-monitor p:nth-child(2) .status-indicator').className = 
                    'status-indicator ' + (backendResponse.ok ? 'status-success' : 'status-error');
            } catch (error) {
                document.getElementById('backend-status').textContent = 'âŒ è¿æ¥å¤±è´¥';
                document.querySelector('#status-monitor p:nth-child(2) .status-indicator').className = 'status-indicator status-error';
            }
            
            // æ£€æŸ¥æœç´¢API
            try {
                const searchResponse = await fetch(`${API_BASE_URL}/stocks/search?keyword=å¹³å®‰&limit=1`);
                const searchData = await searchResponse.json();
                document.getElementById('search-api-status').textContent = 
                    searchResponse.ok && searchData.success ? 'âœ… åŠŸèƒ½æ­£å¸¸' : 'âŒ åŠŸèƒ½å¼‚å¸¸';
                document.querySelector('#status-monitor p:nth-child(3) .status-indicator').className = 
                    'status-indicator ' + (searchResponse.ok && searchData.success ? 'status-success' : 'status-error');
            } catch (error) {
                document.getElementById('search-api-status').textContent = 'âŒ è¿æ¥å¤±è´¥';
                document.querySelector('#status-monitor p:nth-child(3) .status-indicator').className = 'status-indicator status-error';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            checkServiceStatus();
            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡çŠ¶æ€
            setInterval(checkServiceStatus, 30000);
        });
        
        // æ·»åŠ é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                testApiConnection();
            }
        });
    </script>
</body>
</html>